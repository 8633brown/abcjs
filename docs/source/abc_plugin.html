<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js">//    abc_plugin.js: Find everything which looks like abc and convert it

//    Copyright (C) 2010 Gregory Dyke (gregdyke at gmail dot com)
//
//    This program is free software: you can redistribute it and/or modify
//    it under the terms of the GNU General Public License as published by
//    the Free Software Foundation, either version 3 of the License, or
//    (at your option) any later version.
//
//    This program is distributed in the hope that it will be useful,
//    but WITHOUT ANY WARRANTY; without even the implied warranty of
//    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
//    GNU General Public License for more details.
//
//    You should have received a copy of the GNU General Public License
//    along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.

//    requires: abcjs, raphael, jquery

if (!window.ABCJS)
	window.ABCJS = {};

window.ABCJS.Plugin = function() {
	var is_user_script = false;
	try {
		is_user_script = abcjs_is_user_script;
	} catch (ex) {
	}
  this.show_midi = !is_user_script || this.$.browser.mozilla;	// midi currently only works in Firefox, so in the userscript, don't complicate it.
  this.hide_abc = false;
  this.render_before = false;
  this.midi_options = {};
  //this.parse_options = {};
  this.render_options = {};
  this.render_classname = &quot;abcrendered&quot;;
  this.text_classname = &quot;abctext&quot;;
  this.auto_render_threshold = 20;
  this.show_text = &quot;show score for: &quot;;
  //this.hide_text = &quot;hide score for: &quot;;
};

window.ABCJS.Plugin.prototype.start = function(jq) {
	this.$ = jq;
	var body = jq(&quot;body&quot;);
  this.errors=&quot;&quot;;
  var elems = this.getABCContainingElements(this.$(&quot;body&quot;));
  var self = this;
  var divs = elems.map(function(i,elem){
      return self.convertToDivs(elem);
    });
  this.auto_render = (divs.size()&lt;=this.auto_render_threshold);
  divs.each(function(i,elem){
      self.render(elem,self.$(elem).data(&quot;abctext&quot;));
    });
};

// returns a jquery set of the descendants (including self) of elem which have a text node which matches &quot;X:&quot;
window.ABCJS.Plugin.prototype.getABCContainingElements = function(elem) {
  var results = this.$();
  var includeself = false; // whether self is already included (no need to include it again)
  var self = this;
  // TODO maybe look to see whether it's even worth it by using textContent ?
  this.$(elem).contents().each(function() { 
      if (this.nodeType == 3 &amp;&amp; !includeself) {
	if (this.nodeValue.match(/^\s*X:/m)) {
		if (this.parentNode.tagName.toLowerCase() !== 'textarea') {
		  results = results.add(self.$(elem));
		  includeself = true;
		}
	}
      } else if (this.nodeType==1 &amp;&amp; !self.$(this).is(&quot;textarea&quot;)) {
	results = results.add(self.getABCContainingElements(this));
      }
    });
  return results;
};

// in this element there are one or more pieces of abc 
// (and it is not in a subelem)
// for each abc piece, we surround it with a div, store the abctext in the 
// div's data(&quot;abctext&quot;) and return an array 
window.ABCJS.Plugin.prototype.convertToDivs = function (elem) {
  var self = this;
  var contents = this.$(elem).contents();
  var abctext = &quot;&quot;;
  var abcdiv = null;
  var inabc = false;
  var brcount = 0;
  var results = this.$();
  contents.each(function(i,node){
      if (node.nodeType==3 &amp;&amp; !node.nodeValue.match(/^\s*$/)) {
	brcount=0;
	var text = node.nodeValue;
	if (text.match(/^\s*X:/m)) {
	  inabc=true;
	  abctext=&quot;&quot;;
	  abcdiv=self.$(&quot;&lt;div class='&quot;+self.text_classname+&quot;'&gt;&lt;/div&gt;&quot;);
	  self.$(node).before(abcdiv);
	  if (self.hide_abc) {
	    abcdiv.hide();
	  } 
	}
	if (inabc) {
	  abctext += text.replace(/\n+/,&quot;&quot;);
	  abcdiv.append(self.$(node));
	} 
      } else if (inabc &amp;&amp; self.$(node).is(&quot;br&quot;)) {
	abctext += &quot;\n&quot;;
	abcdiv.append(self.$(node));
	brcount++;
	  } else if (inabc &amp;&amp; node.nodeType === 1) {
		  abctext += &quot;\n&quot;;
		 	abcdiv.append(self.$(node));
		  // just swallow this.
      } else if (inabc) { // second br or whitespace textnode
	inabc = false;
	brcount=0;
	abctext = abctext.replace(/\n+/,&quot;\n&quot;); // get rid of extra blank lines
	abcdiv.data(&quot;abctext&quot;,abctext);
	results = results.add(abcdiv);
      }
    });
  if (inabc) {
	  abctext = abctext.replace(/\n+$/,&quot;\n&quot;).replace(/^\n+/,&quot;\n&quot;); // get rid of extra blank lines
    abcdiv.data(&quot;abctext&quot;,abctext);
    results = results.add(abcdiv);
  }
  return results.get();
};

window.ABCJS.Plugin.prototype.render = function (contextnode, abcstring) {
  var abcdiv = this.$(&quot;&lt;div class='&quot;+this.render_classname+&quot;'&gt;&lt;/div&gt;&quot;);
  if (this.render_before) {
    this.$(contextnode).before(abcdiv);
  } else {
    this.$(contextnode).after(abcdiv);
  }
  var self = this;
  try {
    var tunebook = new ABCJS.TuneBook(abcstring);
    var abcParser = new ABCJS.parse.Parse();
    abcParser.parse(tunebook.tunes[0].abc);
    var tune = abcParser.getTune();

    var doPrint = function() {
	try {
	  var paper = Raphael(abcdiv.get(0), 800, 400);
	  var engraver_controller = new ABCJS.write.EngraverController(paper,self.render_options);
	  engraver_controller.engraveABC(tune);
	} catch (ex) { // f*** internet explorer doesn't like innerHTML in weird situations
	  // can't remember why we don't do this in the general case, but there was a good reason
	  abcdiv.remove();
	  abcdiv = this.$(&quot;&lt;div class='&quot;+self.render_classname+&quot;'&gt;&lt;/div&gt;&quot;);
	  paper = Raphael(abcdiv.get(0), 800, 400);
	  engraver_controller = new ABCJS.write.EngraverController(paper);
	  engraver_controller.engraveABC(tune);
	  if (self.render_before) {
	    this.$(contextnode).before(abcdiv);
	  } else {
	    this.$(contextnode).after(abcdiv);
	  }
	}
	if (ABCJS.MidiWriter &amp;&amp; self.show_midi) {
	  var midiwriter = new ABCJS.midi.MidiWriter(abcdiv.get(0),self.midi_options);
	  midiwriter.writeABC(tune);
	}
      };

    var showtext = &quot;&lt;a class='abcshow' href='#'&gt;&quot;+this.show_text+(tune.metaText.title||&quot;untitled&quot;)+&quot;&lt;/a&gt;&quot;;
    
    if (this.auto_render) {
      doPrint();
    } else {
      var showspan = this.$(showtext);
      showspan.click(function(){
	  doPrint();
	  showspan.hide();
	  return false;
	});
      abcdiv.before(showspan);
    }

    } catch (e) {
    this.errors+=e;
   }
};

window.ABCJS.plugin = new window.ABCJS.Plugin();

// There may be a variable defined which controls whether to automatically run the script. If it isn't
// there then it will throw an exception, so we'll catch it here.
$(document).ready(function() {
	var autostart = true;
	try {
		autostart = abcjs_plugin_autostart;
	} catch (ex) {
		// It's ok to fail, and we don't have to do anything.
	}
	if (autostart)
		jQuery(document).ready(ABCJS.plugin.start(jQuery));
})();
</pre>
</body>
</html>
