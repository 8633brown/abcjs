<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta http-equiv="x-ua-compatible" content="ie=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="icon" href="favicon.ico" type="image/x-icon"/>
  <title>abcjs: Basic Demo</title>

  <!-- scripts and styles for MIDI audio player (deprecated?) -->
  <!-- <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" type="text/css" href="../abcjs-midi.css">
  <script src="../bin/abcjs_midi_6.0.0-beta.25-min.js" type="text/javascript"></script> -->

  <!-- stylesheet linked in editor-transpose -->
  <link rel="stylesheet" type="text/css" href="../abcjs-audio.css">
  <script src="../bin/abcjs_basic_6.0.0-beta.25.js" type="text/javascript"></script>
  <style>
    #audio {
      margin-top: 20px;
    }
  </style>
	<script type="text/javascript">
		var abc = "T: Cooley's\n" +
			"M: 4/4\n" +
			"L: 1/8\n" +
			"R: reel\n" +
			"K: Emin\n" +
			"|:D2|EB{c}BA B2 EB|~B2 AB dBAG|FDAD BDAD|FDAD dAFD|\n" +
			"EBBA B2 EB|B2 AB defg|afe^c dBAF|DEFD E2:|\n" +
			"|:gf|eB B2 efge|eB B2 gedB|A2 FA DAFA|A2 FA defg|\n" +
			"eB B2 eBgB|eB B2 defg|afe^c dBAF|DEFD E2:|";

    // todo: if you click Play Output again, it resets the visual rendering and transposeHalfSteps input.
    // todo: transposeHalfSteps input doesn't affect audio playback
		function load() {

      var playOutput = document.querySelector('#play-output');
      // todo: invoke renderAbc outside of listener

      playOutput.addEventListener('click', () => {
        if (ABCJS.synth.supportsAudio()){
          var visualObj = ABCJS.renderAbc("paper", abc);
          
          var createSynth = new ABCJS.synth.CreateSynth();  // initialize sound buffer
          var synthControl = new ABCJS.synth.SynthController();  // iitialize visual widget to control playback
          console.log(synthControl);
          

          window.AudioContext = window.AudioContext ||
            window.webkitAudioContext ||
            navigator.mozAudioContext ||
            navigator.msAudioContext;
          var audioContext = new window.AudioContext();
          
          // todo: break lines 54-76 into its own function
          // don't need to create an audioContext and then resume it; take out 44-60
          audioContext.resume().then(function() {
            // null = cursorControl (required)
            synthControl.load('#audio', null, {
              displayRestart: true,
              displayPlay: true,
              displayProgress: true
            });
          
            // preloads and caches the notes to be played
            createSynth.init({ visualObj: visualObj[0]
            }).then(function() {
                // parameters: setTune(visualObj, userAction, audioParams)
                synthControl.setTune(visualObj[0], false, {
                  audioContext: audioContext,
                  options: {
                    midiTranspose: 0
                  }
                }).then(function(){
                  console.log('Audio successfully loaded.')
                }).catch(function(error) {
                  console.warn('Audio problem: ', error);
                })
            });
          }) 
      }
       else {
        document.querySelector('#audio').innerHTML = 'Audio is not supported in this browser.'
      } 

			var transposeHalfSteps = document.querySelector(".transpose-half-steps");

			transposeHalfSteps.addEventListener("change", function() {
			  visualObj = ABCJS.renderAbc("paper", abc, {
					visualTranspose: transposeHalfSteps.value
        });
        
        // todo
        // use updated audioParams for a new set tune (do I need to call createSynth.init again?)
        // feels that this should be a function of createSynth
        synthControl.setTune(visualObj[0], false, {
                audioContext: audioContext,
                options: {
                  midiTranspose: transposeHalfSteps.value
                }
              }).then(function(){
                console.log('Audio successfully loaded.')
              }).catch(function(error) {
                console.warn('Audio problem: ', error);
              })
      });
    });  
  }

	</script>
</head>
<body onload="load()">
  <label>Transpose half-steps: <input class="transpose-half-steps" type="number" min="-24" max="24" step="1" value="0"></label>
  <button id="play-output">Play Output</button>
  <section class="output">
    <div id="audio"></div>
    <div id="warnings"></div>
    <div id="paper"></div>
  </section>

</body>
</html>
